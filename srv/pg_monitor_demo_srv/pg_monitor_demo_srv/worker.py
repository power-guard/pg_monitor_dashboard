from datetime import datetime
from time import sleep


def dummy_worker(mutex, shmem):
    with mutex:
        shmem['done'] = False
        shmem['proc_start'] = datetime.now().isoformat()
        shmem['proc_end'] = None
        shmem['plants'] = dict()

    for key in dummy_data:
        sleep(3)

        cloned = {
            "name": dummy_data[key]['name'],
            "has_error": dummy_data[key]['has_error'],
            "last_update": set_date_to_today(dummy_data[key]['last_update']),
            "energy_series": [],
            "logs": [],
        }

        for series in dummy_data[key]['energy_series']:
            series_clone = dict()
            for ts in series:
                series_clone[set_date_to_today(ts)] = series[ts]
            cloned['energy_series'].append(series_clone)

        for log in dummy_data[key]['logs']:
            log_clone = {
                "date": set_date_to_today(log['date']),
                "level": log['level'],
                "description": log['description'],
            }
            cloned['logs'].append(log)


        with mutex:
            shmem['plants'][key] = cloned

    with mutex:
        shmem['done'] = True
        shmem['proc_end'] = datetime.now().isoformat()


def set_date_to_today(iso):
    if iso is None:
        return None
    dt = datetime.fromisoformat(iso)
    now = datetime.now()
    return dt.replace(year=now.year, month=now.month, day=now.day).isoformat()


dummy_data = {
    "PGOM1001": {
        "name": "PV発電所００１",
        "has_error": False,
        "last_update": '2021-02-13 14:45:00',
        "energy_series": [
            {
                "2021-02-14T00:15:00": 0.0,
                "2021-02-14T00:30:00": 0.0,
                "2021-02-14T00:45:00": 0.0,
                "2021-02-14T01:00:00": 0.0,
                "2021-02-14T01:15:00": 0.0,
                "2021-02-14T01:30:00": 0.0,
                "2021-02-14T01:45:00": 0.0,
                "2021-02-14T02:00:00": 0.0,
                "2021-02-14T02:15:00": 0.0,
                "2021-02-14T02:30:00": 0.0,
                "2021-02-14T02:45:00": 0.0,
                "2021-02-14T03:00:00": 0.0,
                "2021-02-14T03:15:00": 0.0,
                "2021-02-14T03:30:00": 0.0,
                "2021-02-14T03:45:00": 0.0,
                "2021-02-14T04:00:00": 0.0,
                "2021-02-14T04:15:00": 0.0,
                "2021-02-14T04:30:00": 0.0,
                "2021-02-14T04:45:00": 0.0,
                "2021-02-14T05:00:00": 0.0,
                "2021-02-14T05:15:00": 0.0,
                "2021-02-14T05:30:00": 0.0,
                "2021-02-14T05:45:00": 0.0,
                "2021-02-14T06:00:00": 0.0,
                "2021-02-14T06:15:00": 0.0,
                "2021-02-14T06:30:00": 0.0,
                "2021-02-14T06:45:00": 220.0,
                "2021-02-14T07:00:00": 688.0,
                "2021-02-14T07:15:00": 1504.0,
                "2021-02-14T07:30:00": 1996.0,
                "2021-02-14T07:45:00": 1280.0,
                "2021-02-14T08:00:00": 1400.0,
                "2021-02-14T08:15:00": 1820.0,
                "2021-02-14T08:30:00": 2888.0,
                "2021-02-14T08:45:00": 12024.0,
                "2021-02-14T09:00:00": 17704.0,
                "2021-02-14T09:15:00": 23372.0,
                "2021-02-14T09:30:00": 29528.0,
                "2021-02-14T09:45:00": 29572.0,
                "2021-02-14T10:00:00": 29268.0,
                "2021-02-14T10:15:00": 30012.0,
                "2021-02-14T10:30:00": 29872.0,
                "2021-02-14T10:45:00": 29984.0,
                "2021-02-14T11:00:00": 29976.0,
                "2021-02-14T11:15:00": 29984.0,
                "2021-02-14T11:30:00": 29976.0,
                "2021-02-14T11:45:00": 20016.0
            }
        ],
        "logs": [
            {
                "date": "2021-02-13 14:41:42",
                "level": "INFO",
                "description": "Time adjusted / new time"
            },
            {
                "date": "2021-02-13 14:41:33",
                "level": "INFO",
                "description": "Time adjusted / old time"
            }
        ]
    },
    "PGOM1002": {
        "name": "My Power Plant 2",
        "has_error": False,
        "last_update": None,
        "energy_series": [
            {
                "2021-02-14T00:15:00": 0.0,
                "2021-02-14T00:30:00": 0.0,
                "2021-02-14T00:45:00": 0.0,
                "2021-02-14T01:00:00": 0.0,
                "2021-02-14T01:15:00": 0.0,
                "2021-02-14T01:30:00": 0.0,
                "2021-02-14T01:45:00": 0.0,
                "2021-02-14T02:00:00": 0.0,
                "2021-02-14T02:15:00": 0.0,
                "2021-02-14T02:30:00": 0.0,
                "2021-02-14T02:45:00": 0.0,
                "2021-02-14T03:00:00": 0.0,
                "2021-02-14T03:15:00": 0.0,
                "2021-02-14T03:30:00": 0.0,
                "2021-02-14T03:45:00": 0.0,
                "2021-02-14T04:00:00": 0.0,
                "2021-02-14T04:15:00": 0.0,
                "2021-02-14T04:30:00": 0.0,
                "2021-02-14T04:45:00": 0.0,
                "2021-02-14T05:00:00": 0.0,
                "2021-02-14T05:15:00": 0.0,
                "2021-02-14T05:30:00": 0.0,
                "2021-02-14T05:45:00": 0.0,
                "2021-02-14T06:00:00": 0.0,
                "2021-02-14T06:15:00": 0.0,
                "2021-02-14T06:30:00": 0.0,
                "2021-02-14T06:45:00": 236.0,
                "2021-02-14T07:00:00": 1000.0,
                "2021-02-14T07:15:00": 2220.0,
                "2021-02-14T07:30:00": 2964.0,
                "2021-02-14T07:45:00": 1888.0,
                "2021-02-14T08:00:00": 2068.0,
                "2021-02-14T08:15:00": 2696.0,
                "2021-02-14T08:30:00": 4268.0,
                "2021-02-14T08:45:00": 17348.0,
                "2021-02-14T09:00:00": 26872.0,
                "2021-02-14T09:15:00": 36020.0,
                "2021-02-14T09:30:00": 48652.0,
                "2021-02-14T09:45:00": 48664.0,
                "2021-02-14T10:00:00": 47512.0,
                "2021-02-14T10:15:00": 49716.0,
                "2021-02-14T10:30:00": 49580.0,
                "2021-02-14T10:45:00": 48156.0,
                "2021-02-14T11:00:00": 48844.0,
                "2021-02-14T11:15:00": 49560.0,
                "2021-02-14T11:30:00": 49820.0,
                "2021-02-14T11:45:00": 33232.0
            }
        ],
        "logs": [
            {
                "date": "2021-02-14 10:42:10",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-14 10:42:10",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-14 10:39:20",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-14 10:39:20",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-14 09:40:25",
                "level": "INFO",
                "description": "Time adjusted / new time"
            },
            {
                "date": "2021-02-14 09:40:16",
                "level": "INFO",
                "description": "Time adjusted / old time"
            },
            {
                "date": "2021-02-13 11:14:35",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-13 11:14:35",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-13 11:06:09",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            },
            {
                "date": "2021-02-13 11:06:09",
                "level": "INFO",
                "description": "Active power limited AC voltage"
            }
        ]
    },
    "PGOM1003": {
        "name": "PV System The Third",
        "has_error": False,
        "last_update": '2021-02-14 23:23:10',
        "energy_series": [
            {
                "2021-02-14 06:00:00": 0,
                "2021-02-14 07:00:00": 1213,
                "2021-02-14 08:00:00": 8844,
                "2021-02-14 09:00:00": 15481,
                "2021-02-14 10:00:00": 18447,
                "2021-02-14 11:00:00": 11743,
                "2021-02-14 12:00:00": 7060,
                "2021-02-14 13:00:00": 6622,
                "2021-02-14 14:00:00": 7300,
                "2021-02-14 15:00:00": 4646,
                "2021-02-14 16:00:00": 1312,
                "2021-02-14 17:00:00": 397,
                "2021-02-14 18:00:00": 0,
                "2021-02-14 19:00:00": 0,
                "2021-02-14 20:00:00": 0,
                },
                {
                "2021-02-14 06:00:00": 0,
                "2021-02-14 07:00:00": 1134,
                "2021-02-14 08:00:00": 8697,
                "2021-02-14 09:00:00": 15679,
                "2021-02-14 10:00:00": 18583,
                "2021-02-14 11:00:00": 11835,
                "2021-02-14 12:00:00": 7156,
                "2021-02-14 13:00:00": 6672,
                "2021-02-14 14:00:00": 7391,
                "2021-02-14 15:00:00": 4717,
                "2021-02-14 16:00:00": 1337,
                "2021-02-14 17:00:00": 403,
                "2021-02-14 18:00:00": 0,
                "2021-02-14 19:00:00": 0,
                "2021-02-14 20:00:00": 0,
                },
                {
                "2021-02-14 06:00:00": 0,
                "2021-02-14 07:00:00": 1426,
                "2021-02-14 08:00:00": 9896,
                "2021-02-14 09:00:00": 16567,
                "2021-02-14 10:00:00": 20103,
                "2021-02-14 11:00:00": 12443,
                "2021-02-14 12:00:00": 7156,
                "2021-02-14 13:00:00": 0,
                "2021-02-14 14:00:00": 0,
                "2021-02-14 15:00:00": 0,
                "2021-02-14 16:00:00": 0,
                "2021-02-14 17:00:00": 0,
                "2021-02-14 18:00:00": 0,
                "2021-02-14 19:00:00": 0,
                "2021-02-14 20:00:00": 0,
                },
                {
                "2021-02-14 06:00:00": 0,
                "2021-02-14 07:00:00": 1530,
                "2021-02-14 08:00:00": 9746,
                "2021-02-14 09:00:00": 16992,
                "2021-02-14 10:00:00": 19885,
                "2021-02-14 11:00:00": 12185,
                "2021-02-14 12:00:00": 7052,
                "2021-02-14 13:00:00": 6817,
                "2021-02-14 14:00:00": 7346,
                "2021-02-14 15:00:00": 4569,
                "2021-02-14 16:00:00": 1320,
                "2021-02-14 17:00:00": 399,
                "2021-02-14 18:00:00": 0,
                "2021-02-14 19:00:00": 0,
                "2021-02-14 20:00:00": 0,
                },
                {
                "2021-02-14 06:00:00": 0,
                "2021-02-14 07:00:00": 1230,
                "2021-02-14 08:00:00": 9323,
                "2021-02-14 09:00:00": 15883,
                "2021-02-14 10:00:00": 18512,
                "2021-02-14 11:00:00": 11620,
                "2021-02-14 12:00:00": 6848,
                "2021-02-14 13:00:00": 6377,
                "2021-02-14 14:00:00": 7046,
                "2021-02-14 15:00:00": 4436,
                "2021-02-14 16:00:00": 1260,
                "2021-02-14 17:00:00": 380,
                "2021-02-14 18:00:00": 0,
                "2021-02-14 19:00:00": 0,
                "2021-02-14 20:00:00": 0,
                },
        ],
        "logs": []
    }
}
